#!/bin/bash
set -euo pipefail

DIR="$(cd "$(dirname "$0")" && pwd)"
ENV_FILE="$DIR/.env"

load_env() {
  if [[ ! -f "$ENV_FILE" ]]; then
    echo "Missing .env file. Copy .env.example to .env and fill in your values."
    exit 1
  fi
  source "$ENV_FILE"
  for var in SLACK_TOKEN GCP_PROJECT; do
    if [[ -z "${!var:-}" ]]; then
      echo "Missing $var in .env"
      exit 1
    fi
  done
  BRIAN_NAME="${BRIAN_NAME:-brian}"
  REPO="grovina/brian"
}

gcp_vars() {
  VM="${BRIAN_NAME}"
  ZONE="${GCE_ZONE:-europe-west1-b}"
  MACHINE_TYPE="${GCE_MACHINE_TYPE:-e2-small}"
  BOOT_DISK_SIZE="${GCE_BOOT_DISK_SIZE:-20GB}"
}

run_provision() {
  echo "Installing system packages..."
  $REMOTE_SSH "
    sudo apt-get update &&
    sudo apt-get install -y curl git build-essential ca-certificates gnupg &&
    curl -fsSL https://deb.nodesource.com/setup_22.x | sudo bash - &&
    sudo apt-get install -y nodejs
  "

  echo "Setting up brian user..."
  $REMOTE_SSH "
    id brian &>/dev/null || sudo useradd -m -s /bin/bash brian &&
    echo 'brian ALL=(ALL) NOPASSWD: /usr/bin/systemctl restart brian, /usr/bin/systemctl stop brian, /usr/bin/systemctl start brian, /usr/bin/systemctl daemon-reload' | sudo tee /etc/sudoers.d/brian > /dev/null &&
    sudo chmod 440 /etc/sudoers.d/brian
  "

  echo "Deploying environment..."
  $REMOTE_SCP "$ENV_FILE" "${REMOTE_TARGET}:/tmp/brian.env"
  $REMOTE_SSH "
    sudo mkdir -p /etc/brian &&
    sudo mv /tmp/brian.env /etc/brian/env &&
    sudo chmod 600 /etc/brian/env
  "

  echo "Configuring git..."
  $REMOTE_SSH "
    sudo -u brian git config --global user.name '${BRIAN_NAME}' &&
    sudo -u brian git config --global user.email 'brian@grovina.com' &&
    sudo -u brian git config --global credential.helper store &&
    echo 'https://x-access-token:${GITHUB_TOKEN}@github.com' | sudo -u brian tee /home/brian/.git-credentials > /dev/null &&
    sudo chmod 600 /home/brian/.git-credentials
  "

  echo "Cloning and building..."
  $REMOTE_SSH "
    sudo -u brian bash -c '
      set -e
      if [ -d /home/brian/app ]; then
        cd /home/brian/app
        git remote set-url origin https://github.com/${REPO}.git
        git pull origin main
      else
        git clone https://github.com/${REPO}.git /home/brian/app
        cd /home/brian/app
      fi
      npm ci
      npm run build
      mkdir -p /home/brian/secrets /home/brian/projects
      cp setup/deploy-self.sh /home/brian/deploy-self.sh
      chmod +x /home/brian/deploy-self.sh
    '
  "

  echo "Installing systemd service..."
  $REMOTE_SSH "
    sudo cp /home/brian/app/setup/brian.service /etc/systemd/system/brian.service &&
    sudo systemctl daemon-reload &&
    sudo systemctl enable brian &&
    sudo systemctl restart brian
  "

  echo "Waiting for startup..."
  sleep 10
}

cmd_deploy_gcp() {
  load_env
  gcp_vars

  REMOTE_SSH="gcloud compute ssh $VM --zone=$ZONE --command"
  REMOTE_SCP="gcloud compute scp --zone=$ZONE"
  REMOTE_TARGET="$VM"

  if ! gcloud compute instances describe "$VM" --zone="$ZONE" &>/dev/null; then
    echo "Creating VM '$VM' ($MACHINE_TYPE, $BOOT_DISK_SIZE)..."
    gcloud compute instances create "$VM" \
      --zone="$ZONE" \
      --machine-type="$MACHINE_TYPE" \
      --boot-disk-size="$BOOT_DISK_SIZE" \
      --image-family="debian-12" \
      --image-project="debian-cloud" \
      --scopes="https://www.googleapis.com/auth/cloud-platform" \
      --tags="brian"

    echo "Waiting for SSH..."
    for i in {1..30}; do
      if $REMOTE_SSH "true" &>/dev/null; then break; fi
      sleep 5
    done
  fi

  run_provision

  $REMOTE_SSH "systemctl is-active brian"
  echo "${BRIAN_NAME} is running on GCP!"
}

cmd_deploy_local() {
  local target="${1:?Usage: ./please deploy local user@hostname}"
  load_env

  REMOTE_SSH="ssh $target"
  REMOTE_SCP="scp"
  REMOTE_TARGET="$target"

  echo "Testing SSH connection to $target..."
  if ! $REMOTE_SSH "true" 2>/dev/null; then
    echo "Cannot connect to $target."
    exit 1
  fi

  run_provision

  if $REMOTE_SSH "systemctl is-active brian" &>/dev/null; then
    echo "${BRIAN_NAME} is running!"
  else
    echo "Failed to start. Check: ssh $target 'journalctl -u brian -n 50'"
    exit 1
  fi
}

cmd_destroy() {
  load_env
  gcp_vars
  echo "Destroying VM ($VM in $ZONE)..."
  gcloud compute instances delete "$VM" --zone="$ZONE" --quiet
  echo "Done."
}

cmd_logs() {
  load_env
  gcp_vars
  gcloud compute ssh "$VM" --zone="$ZONE" --command "journalctl -u brian -f"
}

cmd_ssh() {
  load_env
  gcp_vars
  gcloud compute ssh "$VM" --zone="$ZONE"
}

cmd_status() {
  load_env
  gcp_vars
  echo -n "${BRIAN_NAME} on ${VM} (${ZONE}): "
  if gcloud compute ssh "$VM" --zone="$ZONE" --command "systemctl is-active brian" 2>/dev/null; then
    :
  else
    echo "not running (or VM unreachable)"
  fi
}

cmd_restart() {
  load_env
  gcp_vars
  echo "Restarting ${BRIAN_NAME} on ${VM}..."
  gcloud compute ssh "$VM" --zone="$ZONE" --command "sudo -u brian /home/brian/deploy-self.sh"
  echo "Done."
}

cmd_help() {
  cat <<'EOF'
./please â€” the polite CLI for humans

Commands:
  deploy gcp                Deploy brian to a GCP VM
  deploy local user@host    Deploy brian to a local server
  restart                   Pull latest code and restart brian (GCP)
  destroy                   Destroy the GCP VM
  logs                      Tail brian's logs (GCP)
  ssh                       SSH into brian's VM (GCP)
  status                    Check if brian is running (GCP)
  help                      You're looking at it
EOF
}

case "${1:-help}" in
  deploy)
    case "${2:-gcp}" in
      gcp)   cmd_deploy_gcp ;;
      local) cmd_deploy_local "${3:-}" ;;
      *)     echo "Unknown target: $2. Use 'gcp' or 'local'." ;;
    esac
    ;;
  restart) cmd_restart ;;
  destroy) cmd_destroy ;;
  logs)    cmd_logs ;;
  ssh)     cmd_ssh ;;
  status)  cmd_status ;;
  help|*)  cmd_help ;;
esac
